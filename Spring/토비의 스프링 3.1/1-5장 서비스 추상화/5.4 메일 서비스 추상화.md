# Contents

- [5.4.1 JavaMail을 이용한 메일 발송 기능](#541-JavaMail을-이용한-메일-발송-기능)
- [5.4.2 JavaMail이 포함된 코드의 테스트](#542-JavaMail이-포함된-코드의-테스트)
- [5.4.3 테스트를 위한 서비스 추상화](#543-테스트를-위한-서비스-추상화)
- [5.4.4 테스트 대역](#544-테스트-대역)

# 5.4 메일 서비스 추상화

고객으로부터 사용자 레벨 관리에 관한 새로운 요청이 들어왔다. 레벨이 업그레이드되는 사용자에게 안내 메일을 발송해달라는 것이다. 안내 메일을 발송하기 위해 해야 할 일은 두 가지다.

1. 사용자의 이메일 정보를 관리해아 한다. `User`에 `email` 필드를 추가하면 된다.
2. 업그레이드 작업을 담은 `UserService`의 `upgradeLevel()` 메서드에 메일 발송 기능을 추가한다.

## 5.4.1 JavaMail을 이용한 메일 발송 기능

사용자 정보에 이메일을 추가하는 일은 레벨을 추가했을 때와 동일하게 진행하면 된다. 데이터베이스의 `User` 테이블에 `email` 필드를 추가하고, `User` 클래스에 `email` 프로퍼티를 추가한다. 그에 따라 `UserDao`의 `userMapper`와 `insert()`, `update()`에 `email` 필드 처리 코드를 추가하고, 테스트 코드도 수정한다. `User` 생성자에 `email`을 추가하고 `UserDaoTest`를 수정한다.

### JavaMail 메일 발송

자바에서 메일을 발송할 때는 `JavaMail`을 사용하면 된다. `javax.mail` 패키지에서 제공하는 자바의 이메일 클래스를 사용한다. 아래와 같이 `upgradeLevel()` 메서드에 이메일 발송 메서드를 호출한다.

```java
public class UserService {
    // ...
    protected void upgradeLevel(User user) {
        user.upgradeLevel();
        userDao.update(user);
        sendUpgradeEMail(user);
    }

    private void sendUpgradeEMail(User user) {
        Properties props = new Properties();
        props.put("mail.smtp.host", "mail.ksug.org");
        Session s = Session.getInstance(props, null);

        MimeMessage message = new MimeMessage(s);
        try {
            message.setFrom(new InternetAddress("useradmin@ksug.org"));
            message.addRecipient(Message.RecipientType.TO, new InternetAddress(user.getEmail()));
            message.setSubject("Upgrade 안내");
            message.setText("사용자의 등급이 " + user.getLevel().name() + "로 업그레이드되었습니다");

            Transport.send(message);
        } catch (AddressException e) {
            throw new RuntimeException(e);
        } catch (MessagingException e) {
            throw new RuntimeException(e);
        } catch (UnsupportedEncodingException e) {
            throw new RuntimeException(e);
        }
    }
}
```

`JavaMail`을 이용해 메일을 발송하는 전형적인 코드다. 이렇게 해서 업그레이드되는 사용자에게 안내 메일을 발송하는 기능이 추가되었다. `SMTP` 프로토콜을 지원하는 메일 전송 서버가 준비되어 있다면, 이 코드는 정상적으로 동작할 것이고 안내 메일이 발송될 것이다.

## 5.4.2 JavaMail이 포함된 코드의 테스트

## 5.4.3 테스트를 위한 서비스 추상화

### JavaMail을 이용한 테스트의 문제점

### 메일 발송 기능 추상화

### 테스트용 메일 발송 오브젝트

### 테스트와 서비스 추상화

## 5.4.4 테스트 대역

### 의존 오브젝트의 변경을 통한 테스트 방법

### 테스트 대역의 종류와 특징

### 목 오브젝트를 이용한 테스트
